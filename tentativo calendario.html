<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8">
    <title>Tentativo calendario</title>
    <script type="text/javascript">
        // Config
        const cols = 6;
        const rows = 5;
    const labels = ["Lun","Mar","Mer","Gio","Ven","Sab"];

        const subjectsPerDay = [
            ["Filosofia","Religione","Informatica","Italiano","Italiano"],
            ["Chimica","Inglese","Fisica","Informatica","Storia dell'Arte"],
            ["Matematica","Matematica","Chimica","Fisica","Storia"],
            ["Chimica","Scienze della Terra","Storia","Italiano","Filosofia"],
            ["Motoria","Motoria","Inglese","Matematica","Fisica"],
            ["Matematica","Scienze della Terra","Storia dell'Arte","Inglese","Italiano"]
        ];

        const subjectColors = {
            "Filosofia": "#8E44AD",
            "Religione": "#7F8C8D",
            "Informatica": "#3498DB",
            "Italiano": "#E67E22",
            "Chimica": "#27AE60",
            "Inglese": "#1ABC9C",
            "Fisica": "#2980B9",
            "Storia dell'Arte": "#D35400",
            "Matematica": "#C0392B",
            "Storia": "#9B59B6",
            "Scienze della Terra": "#16A085",
            "Motoria": "#F39C12"
        };

        // Events store: key = `${isoDate}-${col}-${row}` -> [{type,text,time,assignees}, ...]
        // assignees: array of student names OR the string 'tutti'
        let eventsByCell = {};

    // list of students
    const students = [
        'Karol','Stefano','Marco','Riccardo C.','Riccardo F.','Federico','Nicolò','Alessandro G. G.','Pietro','Giorgia','Alessio','Piazza','Alessandro P.','Sofia'
    ];

    // selection mode for assigning events to multiple days
    let selectionMode = false;
    let pendingEvent = null; // single-event template {type,text,assignees}
    let pendingEvents = []; // array of event templates when assigning multiple selected events
    const selectedAssignments = new Set(); // keys of selected cells
    const selectedOrder = []; // keep order for undo
    // events selected in the events panel for later assignment
    const selectedEventKeys = new Set();

    // generator mode for automatic assignment of interrogations
    let generatorMode = false;
    const generatorSelections = new Set(); // keys of cells selected for generation

        // Weeks generation: weeks start every 7 days (sette giorni) but each week shows 6 giorni (Lun-Sab)
        const weekStartISO = '2025-12-01';
        const weekEndISO = '2026-06-13';
        let weeks = []; // array of Date objects representing week starts
        let currentWeekIndex = 0;

        function isoDate(d) { // yyyy-mm-dd
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const day = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${day}`;
        }

        function formatShort(d){ // dd/mm
            return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
        }

        function generateWeeks(startISO, endISO){
            const start = new Date(startISO + 'T00:00:00');
            const end = new Date(endISO + 'T00:00:00');
            let cur = new Date(start);
            while (cur <= end){
                weeks.push(new Date(cur));
                cur.setDate(cur.getDate() + 7); // next week (same weekday)
            }
            if (weeks.length === 0) weeks.push(new Date(start));
        }

        function updateCellSize(){
            const container = document.querySelector('.griglia');
            const style = getComputedStyle(container);
            const gap = parseFloat(style.gap) || 0;
            const headerH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 40;
            const availableH = window.innerHeight - 8;
            // leave some extra vertical spacing so the grid doesn't touch top/bottom
            const extraSpace = 80; // px reserved above+below
            const size = Math.floor((availableH - headerH - gap * (rows) - extraSpace) / rows);
            let finalSize = Math.max(36, size);
            // on very small screens (phones) reduce the cell size a bit to fit more comfortably
            try {
                if (window.innerWidth && window.innerWidth <= 420){
                    // scale down for phones but less aggressively than before
                    finalSize = Math.max(32, Math.floor(finalSize * 0.9));
                }
            } catch (e) {}
            document.documentElement.style.setProperty('--cell-size', finalSize + 'px');
        }

        function computeCellEventClassForKey(key){
            const list = eventsByCell[key] || [];
            if (list.some(ev => ev.type === 'Verifica')) return 'ev-verifica';
            if (list.some(ev => ev.type === 'Interrogazione')) return 'ev-interrogazione';
            if (list.some(ev => ev.type === 'Entrata in ritardo' || ev.type === 'Uscita in anticipo')) return 'ev-ritardo';
            return '';
        }

        function applyEventClassToCellByKey(key, cell){
            if (!cell) return;
            cell.classList.remove('ev-verifica','ev-interrogazione','ev-ritardo');
            const cls = computeCellEventClassForKey(key);
            if (cls) cell.classList.add(cls);
            updateCellBadgeByKey(key, cell);
            // visually mark cells selected for pending assignment
            if (selectedAssignments.has(key)) cell.classList.add('assign-selected');
            else cell.classList.remove('assign-selected');
        }

        function updateCellBadgeByKey(key, cell){
            const count = (eventsByCell[key] || []).length;
            if (!cell) return;
            let badge = cell.querySelector('.ev-badge');
            if (!badge){
                badge = document.createElement('div');
                badge.className = 'ev-badge';
                cell.appendChild(badge);
            }
            badge.innerText = count > 0 ? count : '';
            cell.setAttribute('aria-label', `${count} eventi`);
            cell.title = count ? `${count} evento${count>1?'i':''}` : '';
        }

        function showCellModal(colIndex, rowIndex, iso){
            const key = `${iso}-${colIndex}-${rowIndex}`;
            const modal = document.getElementById('cell-modal');
            const overlay = document.getElementById('event-overlay');
            const subject = subjectsPerDay[colIndex][rowIndex];
            modal.querySelector('.cm-subject').innerText = `${subject} — ${formatShort(new Date(iso))}`;
            modal.dataset.col = colIndex;
            modal.dataset.row = rowIndex;
            modal.dataset.date = iso;

            const listContainer = modal.querySelector('.cm-list');
            listContainer.innerHTML = '';
            (eventsByCell[key] || []).forEach((ev, idx) => {
                const row = document.createElement('div');
                row.className = 'cm-item';
                row.innerHTML = `
                    <select class="cm-type">
                        <option ${ev.type==='Interrogazione'?'selected':''}>Interrogazione</option>
                        <option ${ev.type==='Verifica'?'selected':''}>Verifica</option>
                        <option ${ev.type==='Fare i posti'?'selected':''}>Fare i posti</option>
                        <option ${ev.type==='Assemblea'?'selected':''}>Assemblea</option>
                        <option ${ev.type==='Entrata in ritardo'?'selected':''}>Entrata in ritardo</option>
                        <option ${ev.type==='Uscita in anticipo'?'selected':''}>Uscita in anticipo</option>
                        <option ${ev.type==='Altro'?'selected':''}>Altro</option>
                    </select>
                    <input class="cm-text" value="${escapeHtml(ev.text)}" />
                    <button class="cm-save">Salva</button>
                    <button class="cm-del">Elimina</button>
                `;
                // assignees summary
                let assText = '';
                if (ev.assignees === 'tutti') assText = 'Tutti';
                else if (Array.isArray(ev.assignees)) assText = ev.assignees.join(', ');
                if (assText){ const s = document.createElement('div'); s.style.fontSize='12px'; s.style.marginLeft='6px'; s.innerText = `Assegna a: ${assText}`; row.appendChild(s); }

                // editor toggle
                const editAssBtn = document.createElement('button'); editAssBtn.innerText = 'Modifica assegnatari'; editAssBtn.style.marginLeft='8px'; row.appendChild(editAssBtn);
                const assEditor = document.createElement('div'); assEditor.style.display='none'; assEditor.style.flexWrap='wrap'; assEditor.style.gap='6px'; assEditor.style.marginTop='6px';
                // build checkboxes
                const allLbl = document.createElement('label'); const allChk = document.createElement('input'); allChk.type='checkbox'; allChk.value='tutti'; allLbl.appendChild(allChk); allLbl.appendChild(document.createTextNode('Tutti')); assEditor.appendChild(allLbl);
                allChk.addEventListener('change', ()=>{ if (allChk.checked) assEditor.querySelectorAll('input[type=checkbox]').forEach(ch=>{ if (ch!==allChk) ch.checked=false; }); });
                students.forEach(s => { const lbl = document.createElement('label'); const chk = document.createElement('input'); chk.type='checkbox'; chk.value=s; chk.style.marginRight='4px'; lbl.appendChild(chk); lbl.appendChild(document.createTextNode(s)); assEditor.appendChild(lbl); chk.addEventListener('change', ()=>{ if (chk.checked) allChk.checked=false; }); });
                // prefill
                if (ev.assignees === 'tutti') allChk.checked = true;
                else if (Array.isArray(ev.assignees)){
                    ev.assignees.forEach(name => { const ch = Array.from(assEditor.querySelectorAll('input[type=checkbox]')).find(i=>i.value===name); if (ch) ch.checked = true; });
                }
                row.appendChild(assEditor);
                editAssBtn.addEventListener('click', ()=>{ assEditor.style.display = assEditor.style.display==='none'?'flex':'none'; });

                // save / delete handlers
                row.querySelector('.cm-save').addEventListener('click', () => {
                    const newType = row.querySelector('.cm-type').value;
                    const newText = row.querySelector('.cm-text').value.trim() || defaultDescription(newType, subject);
                    // read assignees
                    let newAss = [];
                    if (assEditor){ const all = assEditor.querySelector('input[type=checkbox][value="tutti"]'); if (all && all.checked) newAss = 'tutti'; else { assEditor.querySelectorAll('input[type=checkbox]:checked').forEach(ch=>{ if (ch.value!=='tutti') newAss.push(ch.value); }); } }
                    eventsByCell[key][idx].type = newType;
                    eventsByCell[key][idx].text = newText;
                    eventsByCell[key][idx].assignees = (newAss && newAss.length===0)?[]:newAss;
                    const cell = document.getElementById(`${iso}-${colIndex}-${rowIndex}`);
                    applyEventClassToCellByKey(key, cell);
                    updateEventsPanel();
                    showCellModal(colIndex, rowIndex, iso);
                });
                row.querySelector('.cm-del').addEventListener('click', () => {
                    eventsByCell[key].splice(idx,1);
                    if (eventsByCell[key].length===0) delete eventsByCell[key];
                    const cell = document.getElementById(`${iso}-${colIndex}-${rowIndex}`);
                    applyEventClassToCellByKey(key, cell);
                    updateEventsPanel();
                    showCellModal(colIndex, rowIndex, iso);
                });

                listContainer.appendChild(row);
            });
            const addType = modal.querySelector('#cm-new-type');
            const addText = modal.querySelector('#cm-new-text');
            addType.value = "";
            addText.value = "";
            // store subject on modal so global single listener can use it
            modal.dataset.subj = subject || '';

            // populate cm-assignees area (for adding new event)
            const cmAss = modal.querySelector('.cm-assignees');
            if (cmAss){
                cmAss.innerHTML = '';
                const allLbl = document.createElement('label'); const allChk = document.createElement('input'); allChk.type='checkbox'; allChk.value='tutti'; allLbl.appendChild(allChk); allLbl.appendChild(document.createTextNode('Tutti')); cmAss.appendChild(allLbl);
                allChk.addEventListener('change', ()=>{ if (allChk.checked) cmAss.querySelectorAll('input[type=checkbox]').forEach(ch=>{ if (ch!==allChk) ch.checked=false; }); });
                students.forEach(s => { const lbl = document.createElement('label'); const chk = document.createElement('input'); chk.type='checkbox'; chk.value=s; chk.style.marginRight='4px'; lbl.appendChild(chk); lbl.appendChild(document.createTextNode(s)); cmAss.appendChild(lbl); chk.addEventListener('change', ()=>{ if (chk.checked) allChk.checked=false; }); });
            }

            overlay.style.display = 'block';
            modal.style.display = 'block';
            addType.focus();
        }

        function hideCellModal(){
            document.getElementById('cell-modal').style.display = 'none';
            document.getElementById('event-overlay').style.display = 'none';
        }

        function addEventToCellFromModal(){
            const modal = document.getElementById('cell-modal');
            const col = parseInt(modal.dataset.col,10);
            const row = parseInt(modal.dataset.row,10);
            const iso = modal.dataset.date;
            const type = modal.querySelector('#cm-new-type').value;
            const rawText = modal.querySelector('#cm-new-text').value.trim();
            if (!type) { alert('Scegli un tipo di evento'); return; }
            const subj = (subjectsPerDay[col] && subjectsPerDay[col][row]) ? subjectsPerDay[col][row] : '';
            const text = rawText || defaultDescription(type, subj);
            // gather assignees from modal checkboxes
            const assArea = modal.querySelector('.cm-assignees');
            let assignees = [];
            if (assArea){
                const allChk = assArea.querySelector('input[type=checkbox][value="tutti"]');
                if (allChk && allChk.checked){ assignees = 'tutti'; }
                else {
                    assArea.querySelectorAll('input[type=checkbox]:checked').forEach(ch => { if (ch.value !== 'tutti') assignees.push(ch.value); });
                    if (assignees.length === 0) assignees = []; // none selected
                }
            }

            const key = `${iso}-${col}-${row}`;
            if (!eventsByCell[key]) eventsByCell[key] = [];
            eventsByCell[key].push({ type, text, assignees: (assignees && assignees.length===0)?[]:assignees, time: new Date().toLocaleTimeString() });
            const cell = document.getElementById(`${iso}-${col}-${row}`);
            applyEventClassToCellByKey(key, cell);
            updateEventsPanel();
            showCellModal(col, row, iso);
        }

        function escapeHtml(s){
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function defaultDescription(type, subject){
            if (!type) return subject || '';
            // only include subject for Interrogazione and Verifica
            if (type === 'Interrogazione' || type === 'Verifica'){
                if (!subject) return type;
                return `${type} di ${subject}`;
            }
            // other event types: return only the type
            return type;
        }

        function updateEventsPanel(){
            // show events for the current week grouped by day
            const panel = document.getElementById('events-panel');
            panel.innerHTML = '';

            // top: header + two buttons that open the bulk-create and generator windows
            const top = document.createElement('div');
            top.style.marginBottom = '12px';
            const topH = document.createElement('h2');
            topH.innerText = 'Eventi settimana';
            top.appendChild(topH);

            const btns = document.createElement('div');
            btns.style.display = 'flex'; btns.style.flexDirection = 'column'; btns.style.gap = '8px';

            const openBulk = document.createElement('button'); openBulk.innerText = 'Apri: Creazione eventi (massa)';
            openBulk.addEventListener('click', ()=>{ document.getElementById('bulk-modal').style.display='block'; updateBulkModal(); });
            const openGen = document.createElement('button'); openGen.innerText = 'Apri: Genera interrogazioni';
            openGen.addEventListener('click', ()=>{ document.getElementById('gen-modal').style.display='block'; updateGenModal(); });

            btns.appendChild(openBulk); btns.appendChild(openGen);
            top.appendChild(btns);
            panel.appendChild(top);
            // add interrogazioni panel at the top
            buildInterrogazioniPanel(panel);
            const weekStart = weeks[currentWeekIndex];
            for (let d = 0; d < cols; d++){
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + d);
                const iso = isoDate(dayDate);
                const daySection = document.createElement('div');
                daySection.className = 'events-day';
                const h = document.createElement('div');
                h.className = 'events-day-title';
                h.innerText = `${labels[d]} — ${formatShort(dayDate)}`;
                daySection.appendChild(h);

                    const list = document.createElement('ul');
                    list.className = 'events-list';
                    for (let r = 0; r < rows; r++){
                        const key = `${iso}-${d}-${r}`;
                        (eventsByCell[key] || []).forEach((ev, evIdx) => {
                            const li = document.createElement('li');
                            let assText = '';
                            if (ev.assignees === 'tutti') assText = ' (Tutti)';
                            else if (Array.isArray(ev.assignees) && ev.assignees.length) assText = ` (${ev.assignees.join(', ')})`;
                            li.innerText = `${r+1}°: ${ev.type} — ${ev.text}${assText}`;
                            // store event data for selection/assignment (including assignees)
                            li.dataset.ev = JSON.stringify({ type: ev.type, text: ev.text, assignees: ev.assignees || [] });
                            // unique id for this event item
                            li.id = `evt-${key}-${evIdx}`;
                            li.addEventListener('click', (e)=>{
                                // toggle selected state for this event item
                                const id = li.id;
                                if (selectedEventKeys.has(id)){
                                    selectedEventKeys.delete(id);
                                    li.classList.remove('ev-selected');
                                } else {
                                    selectedEventKeys.add(id);
                                    li.classList.add('ev-selected');
                                }
                            });
                            // restore selection state if any
                            if (selectedEventKeys.has(li.id)) li.classList.add('ev-selected');
                            list.appendChild(li);
                        });
                    }
                daySection.appendChild(list);
                panel.appendChild(daySection);
            }
        }

        function renderWeek(index){
            const container = document.querySelector('.griglia');
            container.innerHTML = '';
            const weekStart = weeks[index];
            // headers with date
            for (let c = 0; c < cols; c++){
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + c);
                const iso = isoDate(dayDate);
                const h = document.createElement('div');
                h.className = 'header';
                h.id = `h-${c}`;
                h.innerText = `${labels[c] || ''} ${formatShort(dayDate)}`;
                h.setAttribute('role','button');
                h.tabIndex = 0;
                h.addEventListener('click', () => toggleColumn(c));
                h.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); h.click(); } });
                container.appendChild(h);
            }

            // cells
            for (let r = 0; r < rows; r++){
                for (let c = 0; c < cols; c++){
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + c);
                    const iso = isoDate(dayDate);
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `${iso}-${c}-${r}`;
                    const subject = (subjectsPerDay[c] && subjectsPerDay[c][r]) || '';

                    const pill = document.createElement('div');
                    pill.className = 'subject-pill';
                    pill.innerText = subject;
                    pill.style.background = subjectColors[subject] || '#ccc';
                    cell.appendChild(pill);

                    const badge = document.createElement('div');
                    badge.className = 'ev-badge';
                    badge.innerText = '';
                    cell.appendChild(badge);

                    cell.addEventListener('click', () => handleCellClick(c, r, iso));
                    cell.setAttribute('role','button');
                    cell.tabIndex = 0;
                    cell.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); cell.click(); } });

                    container.appendChild(cell);
                    const key = `${iso}-${c}-${r}`;
                    applyEventClassToCellByKey(key, cell);
                }
            }

            // update week label and events panel
            const weekLabel = document.getElementById('week-label');
            const endDate = new Date(weekStart);
            endDate.setDate(weekStart.getDate() + (cols-1));
            weekLabel.innerText = `Settimana: ${formatShort(weekStart)} — ${formatShort(endDate)}`;
            updateEventsPanel();
        }

        function toggleColumn(colIndex){
            const header = document.getElementById(`h-${colIndex}`);
            const isSelected = header.classList.toggle('selected');
            const weekStart = weeks[currentWeekIndex];
            for (let r = 0; r < rows; r++){
                const dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + colIndex);
                const iso = isoDate(dayDate);
                const cell = document.getElementById(`${iso}-${colIndex}-${r}`);
                if (cell) cell.classList.toggle('selected', isSelected);
            }
        }

        function handleCellClick(colIndex, rowIndex, iso){
            const key = `${iso}-${colIndex}-${rowIndex}`;
                if (generatorMode){
                    // toggle generator selection
                    if (generatorSelections.has(key)){
                        generatorSelections.delete(key);
                        const cell = document.getElementById(key);
                        if (cell){ cell.classList.remove('assign-selected'); if (cell.dataset.prevTitle !== undefined){ cell.title = cell.dataset.prevTitle; delete cell.dataset.prevTitle; } }
                    } else {
                        generatorSelections.add(key);
                        const cell = document.getElementById(key);
                        if (cell){
                            cell.classList.add('assign-selected');
                            if (cell.dataset.prevTitle === undefined) cell.dataset.prevTitle = cell.title || '';
                            cell.title = 'Selezionato per generazione';
                        }
                    }
                    updateGenModal();
                    return;
                }
                if (selectionMode){
                // toggle selection
                if (selectedAssignments.has(key)){
                    // remove
                    selectedAssignments.delete(key);
                    const idx = selectedOrder.lastIndexOf(key);
                    if (idx !== -1) selectedOrder.splice(idx,1);
                    const cell = document.getElementById(key);
                    if (cell) {
                        cell.classList.remove('assign-selected');
                        // restore previous title if present
                        if (cell.dataset.prevTitle !== undefined){
                            cell.title = cell.dataset.prevTitle;
                            delete cell.dataset.prevTitle;
                        }
                    }
                } else {
                    selectedAssignments.add(key);
                    selectedOrder.push(key);
                    const cell = document.getElementById(key);
                    if (cell) {
                        cell.classList.add('assign-selected');
                        // compute preview description using normal rules
                        const subj = (subjectsPerDay[colIndex] && subjectsPerDay[colIndex][rowIndex]) ? subjectsPerDay[colIndex][rowIndex] : '';
                        let preview = '';
                        if (pendingEvent){
                            preview = (pendingEvent.text && String(pendingEvent.text).trim()) ? pendingEvent.text : defaultDescription(pendingEvent.type, subj);
                        }
                        // store previous title and set preview as title
                        if (cell.dataset.prevTitle === undefined) cell.dataset.prevTitle = cell.title || '';
                        if (preview) cell.title = preview;
                    }
                }
                // update toolbar (we'll update count/visibility elsewhere)
                updateAssignToolbar();
                return;
            }
            // normal behavior: show modal for that cell
            showCellModal(colIndex, rowIndex, iso);
        }

        document.addEventListener('DOMContentLoaded', () => {
            generateWeeks(weekStartISO, weekEndISO);
            // build top controls
            const wrapper = document.querySelector('.griglia-wrapper');
            const controls = document.createElement('div');
            // place controls in document flow above the grid so they don't overlap any content
            controls.style.display = 'flex';
            controls.style.alignItems = 'center';
            controls.style.gap = '8px';
            controls.style.margin = '8px';
            controls.style.padding = '6px';
            controls.style.background = 'rgba(255,255,255,0.96)';
            controls.style.borderRadius = '8px';
            controls.style.boxShadow = '0 6px 20px rgba(0,0,0,0.06)';
            controls.style.zIndex = '1200';

            const prevBtn = document.createElement('button');
            prevBtn.innerText = '◀';
            prevBtn.addEventListener('click', () => { if (currentWeekIndex>0) { currentWeekIndex--; renderWeek(currentWeekIndex); } });
            const nextBtn = document.createElement('button');
            nextBtn.innerText = '▶';
            nextBtn.addEventListener('click', () => { if (currentWeekIndex < weeks.length-1) { currentWeekIndex++; renderWeek(currentWeekIndex); } });

            const weekLabel = document.createElement('div');
            weekLabel.id = 'week-label';
            weekLabel.style.fontWeight = '700';

            const select = document.createElement('select');
            weeks.forEach((w, idx) =>{
                const opt = document.createElement('option');
                const start = formatShort(w);
                const end = formatShort(new Date(w.getFullYear(), w.getMonth(), w.getDate() + (cols-1)));
                opt.value = idx;
                opt.innerText = `${start} — ${end}`;
                select.appendChild(opt);
            });
            select.addEventListener('change', (e)=>{ currentWeekIndex = parseInt(e.target.value,10); renderWeek(currentWeekIndex); });

            controls.appendChild(prevBtn);
            controls.appendChild(weekLabel);
            controls.appendChild(nextBtn);
            controls.appendChild(select);
            // insert controls before the wrapper so they push the grid down and never overlap
            wrapper.parentNode.insertBefore(controls, wrapper);
            // ensure the fixed wrapper is offset from top to avoid overlap with controls
            try {
                const topOffsetPx = controls.offsetHeight + 12; // controls height + margin
                wrapper.style.top = topOffsetPx + 'px';
                // leave a little bottom gap so table doesn't touch bottom
                wrapper.style.bottom = '18px';
            } catch (e) {
                // ignore if measurement fails
            }

            // overlay + modal for cell events
            const overlay = document.createElement('div');
            overlay.id = 'event-overlay';
            overlay.addEventListener('click', hideAllModals);
            document.body.appendChild(overlay);

            const modal = document.createElement('div');
            modal.id = 'cell-modal';
            modal.className = 'modal-window';
            modal.innerHTML = `
                <div class="cm-header">Eventi — <span class="cm-subject"></span></div>
                <div class="cm-list"></div>
                <div class="cm-add">
                    <select id="cm-new-type">
                        <option value="">-- scegli --</option>
                        <option>Interrogazione</option>
                        <option>Verifica</option>
                        <option>Fare i posti</option>
                        <option>Assemblea</option>
                        <option>Entrata in ritardo</option>
                        <option>Uscita in anticipo</option>
                        <option>Altro</option>
                    </select>
                    <input id="cm-new-text" placeholder="Descrizione (opzionale)"/>
                    <div style="display:flex;flex-direction:column;gap:6px;margin-top:6px;min-width:200px;">
                        <div style="font-size:12px;color:#555;font-weight:600;">Assegnatari</div>
                        <div class="cm-assignees" style="display:flex;flex-wrap:wrap;gap:6px;max-height:120px;overflow:auto;border:1px solid #f0f2f5;padding:6px;border-radius:6px;background:#fbfcff;"></div>
                    </div>
                    <button id="cm-add-btn">Aggiungi</button>
                    <button id="cm-close-btn">Chiudi</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#cm-add-btn').addEventListener('click', addEventToCellFromModal);
            modal.querySelector('#cm-close-btn').addEventListener('click', hideCellModal);
            // attach single change listener for cm-new-type that uses modal.dataset.subj
            const modalAddType = modal.querySelector('#cm-new-type');
            const modalAddText = modal.querySelector('#cm-new-text');
            modalAddType.addEventListener('change', () => {
                const subj = modal.dataset.subj || '';
                modalAddText.placeholder = defaultDescription(modalAddType.value, subj);
            });

            const eventsPanel = document.createElement('div');
            eventsPanel.id = 'events-panel';
            document.body.appendChild(eventsPanel);
            
                // build interrogazioni panel function (exposed globally)
                window.buildInterrogazioniPanel = function(parent){
                    const container = document.createElement('div');
                    container.className = 'interro-section';
                    const h = document.createElement('h3'); h.innerText = 'Interrogazioni'; h.style.marginTop='0'; container.appendChild(h);
                    // group interrogazioni by subject
                    const subjMap = {}; // subj -> { inWeek: {dayIndex: [ {names, dateStr} ] }, other: [ {dateStr, names} ] }
                    const keys = Object.keys(eventsByCell);
                    for (let k of keys){
                        const parts = k.split('-');
                        const row = parseInt(parts.pop(),10);
                        const col = parseInt(parts.pop(),10);
                        const dateStr = k.substring(0,10);
                        const subj = (subjectsPerDay[col] && subjectsPerDay[col][row]) ? subjectsPerDay[col][row] : 'Altro';
                        for (let ev of (eventsByCell[k]||[])){
                            if (ev.type !== 'Interrogazione') continue;
                            if (!subjMap[subj]) subjMap[subj] = { inWeek: {}, other: [] };
                            // check if date is in current week
                            const weekStart = weeks[currentWeekIndex];
                            const ws = new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate());
                            const we = new Date(ws); we.setDate(ws.getDate() + (cols-1));
                            const d = new Date(dateStr+'T00:00:00');
                            if (d >= ws && d <= we){
                                const dayIdx = Math.floor((d - ws)/(1000*60*60*24));
                                if (!subjMap[subj].inWeek[dayIdx]) subjMap[subj].inWeek[dayIdx] = [];
                                subjMap[subj].inWeek[dayIdx].push({ names: ev.assignees === 'tutti' ? ['Tutti'] : (Array.isArray(ev.assignees)?ev.assignees.slice():[]), date: dateStr });
                            } else {
                                subjMap[subj].other.push({ names: ev.assignees === 'tutti' ? ['Tutti'] : (Array.isArray(ev.assignees)?ev.assignees.slice():[]), date: dateStr });
                            }
                        }
                    }
                    // build accordion only for subjects with any entries
                    const accordion = document.createElement('div'); accordion.className = 'subj-accordion';
                    Object.keys(subjMap).sort().forEach(subj => {
                        const info = subjMap[subj];
                        // sum lengths safely
                        const inWeekVals = Object.values(info.inWeek || {});
                        const inWeekCount = inWeekVals.reduce((acc, arr) => acc + (Array.isArray(arr) ? arr.length : 0), 0);
                        const totalCount = inWeekCount + (Array.isArray(info.other) ? info.other.length : 0);
                        if (totalCount === 0) return;
                        const btn = document.createElement('div'); btn.className = 'subj-btn'; btn.innerText = `${subj} (${totalCount})`;
                        const content = document.createElement('div'); content.className = 'subj-content';
                        const inWeekHeader = document.createElement('div'); inWeekHeader.style.fontWeight='700'; inWeekHeader.style.marginBottom='6px'; inWeekHeader.innerText = 'Questa settimana';
                        content.appendChild(inWeekHeader);
                        const rowsDiv = document.createElement('div'); rowsDiv.className = 'subj-rows';
                        // days order
                        for (let d=0; d<cols; d++){
                            const arr = info.inWeek[d] || [];
                            if (arr.length===0) continue;
                            const dayLine = document.createElement('div'); dayLine.className='day-line';
                            const dayDate = new Date(weeks[currentWeekIndex]); dayDate.setDate(dayDate.getDate()+d);
                            dayLine.innerHTML = `<strong>${labels[d]} — ${formatShort(dayDate)}</strong><div style="margin-top:6px;">${arr.map(x=> x.names.join(', ')).join('<br>')}</div>`;
                            rowsDiv.appendChild(dayLine);
                        }
                        content.appendChild(rowsDiv);
                        if (info.other.length){
                            const otherHeader = document.createElement('div'); otherHeader.style.fontWeight='700'; otherHeader.style.marginTop='8px'; otherHeader.style.marginBottom='6px'; otherHeader.innerText = 'Altre date';
                            content.appendChild(otherHeader);
                            info.other.sort((a,b)=>a.date.localeCompare(b.date)).forEach(it=>{
                                const otherLine = document.createElement('div'); otherLine.className='other-line';
                                const d = new Date(it.date+'T00:00:00');
                                // map JS getDay (0=Sun..6=Sat) to our labels (0=Mon..5=Sat)
                                const idx = (d.getDay() + 6) % 7; // Monday -> 0
                                const dayName = (idx >= 0 && idx < labels.length) ? labels[idx] : formatShort(d);
                                otherLine.innerHTML = `<strong>${dayName} — ${formatShort(d)}</strong><div style="margin-top:6px;">${it.names.join(', ')}</div>`;
                                content.appendChild(otherLine);
                            });
                        }
                        btn.addEventListener('click', ()=>{ content.classList.toggle('open'); });
                        accordion.appendChild(btn); accordion.appendChild(content);
                    });
                    container.appendChild(accordion);
                    parent.appendChild(container);
                }

            // assign toolbar (hidden until selectionMode)
            const assignToolbar = document.createElement('div');
            assignToolbar.id = 'assign-toolbar';
            assignToolbar.style.position = 'fixed';
            assignToolbar.style.right = '16px';
            assignToolbar.style.bottom = '16px';
            assignToolbar.style.display = 'none';
            assignToolbar.style.gap = '8px';
            assignToolbar.style.padding = '8px';
            assignToolbar.style.background = 'rgba(255,255,255,0.98)';
            assignToolbar.style.border = '1px solid #dcdcdc';
            assignToolbar.style.borderRadius = '8px';
            assignToolbar.style.boxShadow = '0 6px 20px rgba(0,0,0,0.12)';
            assignToolbar.style.zIndex = '2300';

            const assignCount = document.createElement('span');
            assignCount.id = 'assign-count';
            assignCount.innerText = '';

            const undoBtn = document.createElement('button');
            undoBtn.innerText = 'Annulla ultimo';
            undoBtn.addEventListener('click', ()=>{
                if (selectedOrder.length===0) return;
                const last = selectedOrder.pop();
                selectedAssignments.delete(last);
                const cell = document.getElementById(last);
                if (cell) {
                    cell.classList.remove('assign-selected');
                    if (cell.dataset.prevTitle !== undefined){
                        cell.title = cell.dataset.prevTitle;
                        delete cell.dataset.prevTitle;
                    }
                }
                updateAssignToolbar();
            });

            const cancelBtn = document.createElement('button');
            cancelBtn.innerText = 'Annulla tutto';
            cancelBtn.addEventListener('click', ()=>{
                // clear selections but keep selectionMode active so user can start over
                selectedAssignments.forEach(k => {
                    const cell = document.getElementById(k);
                    if (cell) {
                        cell.classList.remove('assign-selected');
                        if (cell.dataset.prevTitle !== undefined){
                            cell.title = cell.dataset.prevTitle;
                            delete cell.dataset.prevTitle;
                        }
                    }
                });
                selectedAssignments.clear(); selectedOrder.length = 0;
                updateAssignToolbar();
            });

            const exitBtn = document.createElement('button');
            exitBtn.innerText = 'Annulla selezione';
            exitBtn.addEventListener('click', ()=>{
                // cancel selection mode completely
                selectedAssignments.forEach(k => {
                    const cell = document.getElementById(k);
                    if (cell) {
                        cell.classList.remove('assign-selected');
                        if (cell.dataset.prevTitle !== undefined){
                            cell.title = cell.dataset.prevTitle;
                            delete cell.dataset.prevTitle;
                        }
                    }
                });
                selectedAssignments.clear(); selectedOrder.length = 0;
                selectionMode = false; pendingEvent = null;
                updateAssignToolbar();
            });

            const finishBtn = document.createElement('button');
            finishBtn.innerText = 'Conferma selezione';
            finishBtn.addEventListener('click', ()=>{
                if (pendingEvents && pendingEvents.length>0){
                    // apply each pending event template to all selectedAssignments
                    selectedAssignments.forEach(k => {
                        const parts = k.split('-');
                        const row = parseInt(parts.pop(),10);
                        const col = parseInt(parts.pop(),10);
                        const subj = (subjectsPerDay[col] && subjectsPerDay[col][row]) ? subjectsPerDay[col][row] : '';
                        if (!eventsByCell[k]) eventsByCell[k] = [];
                        pendingEvents.forEach(pe => {
                            const text = (pe.text && String(pe.text).trim()) ? pe.text : defaultDescription(pe.type, subj);
                            eventsByCell[k].push({ type: pe.type, text: text, assignees: pe.assignees || [], time: new Date().toLocaleTimeString() });
                        });
                    });
                } else if (pendingEvent){
                    // apply pendingEvent to all selectedAssignments — build text per-cell using subject rules
                    selectedAssignments.forEach(k => {
                        // k format: YYYY-MM-DD-col-row -> need col,row
                        const parts = k.split('-');
                        const row = parseInt(parts.pop(),10);
                        const col = parseInt(parts.pop(),10);
                        const subj = (subjectsPerDay[col] && subjectsPerDay[col][row]) ? subjectsPerDay[col][row] : '';
                        const text = (pendingEvent.text && String(pendingEvent.text).trim()) ? pendingEvent.text : defaultDescription(pendingEvent.type, subj);
                        if (!eventsByCell[k]) eventsByCell[k] = [];
                        eventsByCell[k].push({ type: pendingEvent.type, text: text, assignees: pendingEvent.assignees || [], time: new Date().toLocaleTimeString() });
                    });
                } else return;
                // cleanup (restore titles)
                selectedAssignments.forEach(k => {
                    const cell = document.getElementById(k);
                    if (cell) {
                        cell.classList.remove('assign-selected');
                        if (cell.dataset.prevTitle !== undefined){
                            // let updateEventsPanel update title based on count; but remove prevTitle
                            delete cell.dataset.prevTitle;
                        }
                    }
                });
                selectedAssignments.clear(); selectedOrder.length = 0;
                selectionMode = false; pendingEvent = null;
                assignToolbar.style.display = 'none';
                updateEventsPanel();
                renderWeek(currentWeekIndex);
                // ensure overlays/modals are hidden so user can continue interacting
                try { hideAllModals(); } catch (e) { /* ignore if not available */ }
            });

            assignToolbar.appendChild(assignCount);
            assignToolbar.appendChild(undoBtn);
            assignToolbar.appendChild(cancelBtn);
            assignToolbar.appendChild(exitBtn);
            assignToolbar.appendChild(finishBtn);
            document.body.appendChild(assignToolbar);

            // create bulk creation modal and generator modal (hidden until opened)
            const bulkModal = document.createElement('div');
            bulkModal.id = 'bulk-modal';
            bulkModal.className = 'modal-window';
            bulkModal.style.display = 'none';
            bulkModal.innerHTML = `
                <h3>Creazione eventi in massa</h3>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <select id="bulk-type"><option value="">-- scegli tipo (obbligatorio) --</option><option>Interrogazione</option><option>Verifica</option><option>Fare i posti</option><option>Assemblea</option><option>Entrata in ritardo</option><option>Uscita in anticipo</option><option>Altro</option></select>
                    <input id="bulk-text" placeholder="Descrizione (opzionale)" />
                    <div style="font-size:12px;color:#555;font-weight:600;">Assegnatari</div>
                    <div id="bulk-assignees" style="display:flex;flex-wrap:wrap;gap:6px;max-height:140px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:6px;background:#fbfcff;"></div>
                    <div style="display:flex;gap:8px;">
                        <button id="bulk-start-select">Start selezione giorni</button>
                        <button id="bulk-apply-now">Applica agli attuali giorni selezionati</button>
                        <button id="bulk-close">Chiudi</button>
                    </div>
                    <div id="bulk-selected-list" style="margin-top:8px;font-size:13px;color:#333;"></div>
                </div>
            `;
            document.body.appendChild(bulkModal);

            const genModal = document.createElement('div');
            genModal.id = 'gen-modal';
            genModal.className = 'modal-window';
            genModal.style.display = 'none';
            genModal.innerHTML = `
                <h3>Genera interrogazioni</h3>
                <div style="display:flex;flex-direction:column;gap:8px;">
                    <div style="display:flex;gap:8px;">
                        <button id="gen-start-select">Start selezione giorni</button>
                        <button id="gen-refresh-list">Aggiorna giorni selezionati</button>
                        <button id="gen-close">Chiudi</button>
                    </div>
                    <div id="gen-days-list" style="max-height:240px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px;"></div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <label>Lookback (giorni): <input id="gen-lookback" type="number" value="7" min="1" style="width:80px;margin-left:6px;"/></label>
                        <label>Lookforward (giorni): <input id="gen-lookforward" type="number" value="3" min="0" style="width:80px;margin-left:6px;"/></label>
                        <label style="display:flex;align-items:center;gap:6px;">Casualità: <input id="gen-randomness" type="range" min="0" max="2" step="0.1" value="1.6" style="width:140px;"/></label>
                        <label style="display:flex;align-items:center;gap:6px;">Penalità ripet.: <input id="gen-penalty" type="range" min="0" max="5" step="0.1" value="2.5" style="width:140px;"/></label>
                        <div id="gen-total" style="font-weight:700;margin-left:6px;">Totale: 0</div>
                        <div id="gen-warning" style="color:#a33;font-weight:700;margin-left:8px;flex:1;"></div>
                        <button id="gen-run">Genera</button>
                    </div>
                </div>
            `;
            document.body.appendChild(genModal);

            // hide all modals helper
            function hideAllModals(){
                const overlayEl = document.getElementById('event-overlay');
                overlayEl.style.display = 'none';
                ['cell-modal','bulk-modal','gen-modal'].forEach(id=>{ const el = document.getElementById(id); if (el) el.style.display='none'; });
                // cancel any selection modes
                selectionMode = false; pendingEvent = null; pendingEvents = [];
                generatorMode = false; // keep generatorSelections as-is until user cancels explicitly
                updateAssignToolbar(); updateBulkModal(); updateGenModal();
            }
            // allow Escape to close modals quickly
            window.addEventListener('keydown', (ev)=>{
                if (ev.key === 'Escape') hideAllModals();
            });
            // (overlay listener already attached earlier)

            // populate bulk assignees area
            function buildBulkAssignees(){
                const area = document.getElementById('bulk-assignees');
                if (!area) return;
                area.innerHTML='';
                const allLbl = document.createElement('label'); const allChk = document.createElement('input'); allChk.type='checkbox'; allChk.value='tutti'; allLbl.appendChild(allChk); allLbl.appendChild(document.createTextNode('Tutti')); area.appendChild(allLbl);
                allChk.addEventListener('change', ()=>{ if (allChk.checked) area.querySelectorAll('input[type=checkbox]').forEach(ch=>{ if (ch!==allChk) ch.checked=false; }); });
                students.forEach(s=>{ const lbl=document.createElement('label'); const chk=document.createElement('input'); chk.type='checkbox'; chk.value=s; chk.style.marginRight='4px'; lbl.appendChild(chk); lbl.appendChild(document.createTextNode(s)); area.appendChild(lbl); chk.addEventListener('change', ()=>{ if (chk.checked) allChk.checked=false; }); });
            }

            // update bulk modal UI (selected days list)
            window.updateBulkModal = function(){
                const list = document.getElementById('bulk-selected-list'); if (!list) return;
                const applyBtn = document.getElementById('bulk-apply-now');
                if (selectedAssignments.size===0){ list.innerText = 'Giorni selezionati: 0'; if (applyBtn) applyBtn.disabled = true; }
                else {
                    const arr = Array.from(selectedAssignments);
                    list.innerHTML = 'Giorni selezionati:<br>' + arr.map(k=>{ const d=new Date(k.substring(0,10)+'T00:00:00'); return `${formatShort(d)} (${k.substring(0,10)})`; }).join('<br>');
                    if (applyBtn) applyBtn.disabled = false;
                }
                buildBulkAssignees();
            }

            // update generator modal UI (selected days with dropdowns)
            window.updateGenModal = function(){
                const el = document.getElementById('gen-days-list'); if (!el) return;
                el.innerHTML = '';
                if (generatorSelections.size===0){ el.innerText = 'Nessun giorno selezionato.'; return; }
                const arr = Array.from(generatorSelections).sort();
                arr.forEach(k=>{
                    const dateStr = k.substring(0,10);
                    const d = new Date(dateStr+'T00:00:00');
                    const row = document.createElement('div');
                    row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginBottom='6px';
                    const label = document.createElement('div'); label.innerText = `${formatShort(d)} — ${dateStr}`; row.appendChild(label);
                    const sel = document.createElement('select'); sel.dataset.key = k;
                    // allow up to the full class size per day (but validation will prevent exceeding total)
                    for (let i=1;i<=students.length;i++){ const o=document.createElement('option'); o.value=i; o.innerText=i; sel.appendChild(o); }
                    // update validation when user changes number per day
                    sel.addEventListener('change', ()=>{ validateGenSelections(); });
                    row.appendChild(sel);
                    el.appendChild(row);
                });
                // run validation after building list
                validateGenSelections();
            }

            // wire bulk modal buttons
            document.body.addEventListener('click', (e)=>{
                if (!e.target) return;
                if (e.target.id === 'bulk-start-select'){
                    // begin selecting days for bulk: hide modal and enable selection on grid
                    selectionMode = true; pendingEvent = null; pendingEvents = [];
                    // hide the bulk modal so the grid is clickable
                    const bm = document.getElementById('bulk-modal'); if (bm) bm.style.display = 'none';
                    updateAssignToolbar(); updateBulkModal();
                    alert('Seleziona le celle target nella griglia, poi riapri il pannello e premi "Applica".');
                }
                if (e.target.id === 'bulk-apply-now'){
                    const type = document.getElementById('bulk-type').value;
                    const text = document.getElementById('bulk-text').value.trim();
                    if (!type){ alert('Scegli un tipo per gli eventi'); return; }
                    // gather assignees
                    const area = document.getElementById('bulk-assignees'); let ass = [];
                    if (area){ const all = area.querySelector('input[type=checkbox][value="tutti"]'); if (all && all.checked) ass='tutti'; else { area.querySelectorAll('input[type=checkbox]:checked').forEach(ch=>{ if (ch.value!=='tutti') ass.push(ch.value); }); } }
                    selectedAssignments.forEach(k=>{
                        const parts = k.split('-'); const row = parseInt(parts.pop(),10); const col = parseInt(parts.pop(),10);
                        const subj = (subjectsPerDay[col] && subjectsPerDay[col][row])?subjectsPerDay[col][row]:'';
                        const finalText = text || defaultDescription(type, subj);
                        if (!eventsByCell[k]) eventsByCell[k]=[];
                        eventsByCell[k].push({ type, text: finalText, assignees: (ass && ass.length===0)?[]:ass, time: new Date().toLocaleTimeString() });
                    });
                    // cleanup
                    selectedAssignments.forEach(k=>{ const cell=document.getElementById(k); if (cell){ cell.classList.remove('assign-selected'); if (cell.dataset.prevTitle!==undefined){ delete cell.dataset.prevTitle; } } });
                    selectedAssignments.clear(); selectedOrder.length=0; selectionMode=false;
                    updateBulkModal(); updateAssignToolbar(); updateEventsPanel(); renderWeek(currentWeekIndex); hideAllModals();
                }
                if (e.target.id === 'bulk-close') hideAllModals();
                if (e.target.id === 'gen-start-select'){
                    // start selecting days for generator: hide modal to allow clicking grid
                    generatorMode = true; const gm = document.getElementById('gen-modal'); if (gm) gm.style.display = 'none'; updateGenModal(); alert('Seleziona le celle per le interrogazioni nella griglia. Torna qui e premi "Aggiorna giorni selezionati".');
                }
                if (e.target.id === 'gen-refresh-list') updateGenModal();
                if (e.target.id === 'gen-run'){
                    const look = parseInt(document.getElementById('gen-lookback').value||'7',10) || 7;
                    const lookforward = parseInt(document.getElementById('gen-lookforward').value||'0',10) || 0;
                    // read per-day numbers from selects
                    const perDayNumbers = {};
                    document.querySelectorAll('#gen-days-list select').forEach(s=>{ perDayNumbers[s.dataset.key] = parseInt(s.value,10) || 1; });
                    // validate against total students
                    const totalRequested = Object.values(perDayNumbers).reduce((a,b)=>a+(b||0),0);
                    if (totalRequested > students.length){ alert(`Hai richiesto ${totalRequested} assegnazioni ma ci sono solo ${students.length} studenti. Riduci i numeri.`); return; }
                    runGenerator(perDayNumbers, look, lookforward);
                    hideAllModals();
                }
                if (e.target.id === 'gen-close') hideAllModals();
            });

            // helper to compute days since last assignment for a student (ignore events assigned to 'tutti')
            function daysSinceLastAssignment(student, beforeDateISO, eventTypes, lookbackDays){
                let last = null;
                const beforeDate = new Date(beforeDateISO + 'T00:00:00');
                const keys = Object.keys(eventsByCell);
                for (let k of keys){
                    const dateStr = k.substring(0,10); // YYYY-MM-DD
                    const evDate = new Date(dateStr + 'T00:00:00');
                    if (evDate >= beforeDate) continue; // only prior events
                    const daysDiff = Math.floor((beforeDate - evDate) / (1000*60*60*24));
                    if (lookbackDays && daysDiff > lookbackDays) continue; // outside lookback window
                    const list = eventsByCell[k] || [];
                    for (let ev of list){
                        if (eventTypes && eventTypes.length && !eventTypes.includes(ev.type)) continue;
                        if (ev.assignees === 'tutti') continue; // ignore all-people events
                        if (Array.isArray(ev.assignees) && ev.assignees.includes(student)){
                            if (!last || evDate > last) last = evDate;
                        }
                    }
                }
                if (!last) return 365; // large number if never assigned
                return Math.floor((beforeDate - last)/(1000*60*60*24));
            }

            // compute minimal absolute day distance from target date to any assignment of student
            // searches both backward and forward within the provided windows
            function daysDistanceNearest(student, targetDateISO, eventTypes, lookbackDays, lookforwardDays){
                const target = new Date(targetDateISO + 'T00:00:00');
                let min = null;
                const keys = Object.keys(eventsByCell);
                for (let k of keys){
                    const dateStr = k.substring(0,10);
                    const evDate = new Date(dateStr + 'T00:00:00');
                    const diff = Math.floor((evDate - target) / (1000*60*60*24)); // can be negative (past) or positive (future)
                    if (diff < 0){
                        if (typeof lookbackDays === 'number' && Math.abs(diff) > lookbackDays) continue;
                    } else {
                        if (typeof lookforwardDays === 'number' && diff > lookforwardDays) continue;
                    }
                    const list = eventsByCell[k] || [];
                    for (let ev of list){
                        if (eventTypes && eventTypes.length && !eventTypes.includes(ev.type)) continue;
                        if (ev.assignees === 'tutti') continue;
                        if (Array.isArray(ev.assignees) && ev.assignees.includes(student)){
                            const absd = Math.abs(diff);
                            if (min === null || absd < min) min = absd;
                        }
                    }
                }
                if (min === null) return 365; // not found -> large distance
                return min;
            }

            // validate gen selections: total requested across selected days must not exceed total students
            window.validateGenSelections = function(){
                const warning = document.getElementById('gen-warning');
                const runBtn = document.getElementById('gen-run');
                const totalEl = document.getElementById('gen-total');
                if (!runBtn) return;
                const selects = Array.from(document.querySelectorAll('#gen-days-list select'));
                if (selects.length === 0){ runBtn.disabled = true; if (warning) warning.innerText = 'Nessun giorno selezionato.'; if (totalEl) totalEl.innerText = 'Totale: 0'; return; }
                const total = selects.reduce((acc, s) => acc + (parseInt(s.value,10) || 0), 0);
                if (total > students.length){ runBtn.disabled = true; if (warning) warning.innerText = `Totale richieste ${total} > studenti disponibili ${students.length}`; }
                else if (total === 0){ runBtn.disabled = true; if (warning) warning.innerText = 'Scegli almeno 1 studente totale.'; }
                else { runBtn.disabled = false; if (warning) warning.innerText = ''; }
                if (totalEl) totalEl.innerText = `Totale: ${total} / ${students.length}`;
            }

            // run generator: perDayNumbers is { key: n }, lookbackDays and lookforwardDays control window
            window.runGenerator = function(perDayNumbers, lookbackDays, lookforwardDays){
                const eventTypes = ['Interrogazione','Verifica'];
                const selections = Array.from(generatorSelections).sort();
                // keep track of how many times a student has been assigned in this run to encourage distribution
                const assignedCount = {};
                students.forEach(s=>assignedCount[s]=0);

                // for each selected day choose N students
                for (let k of selections){
                    const dateStr = k.substring(0,10);
                    const parts = k.split('-');
                    const row = parseInt(parts.pop(),10);
                    const col = parseInt(parts.pop(),10);
                    const subj = (subjectsPerDay[col] && subjectsPerDay[col][row]) ? subjectsPerDay[col][row] : '';
                    const N = Math.min(perDayNumbers[k] || 1, students.length);
                    // build scores: larger distance (either past or future) => higher score; penalize students already chosen in this run
                    // read randomness and penalty from UI sliders (defaults retained if missing)
                    const randomness = parseFloat((document.getElementById('gen-randomness')||{value:1.6}).value) || 1.6;
                    const penaltyCoeff = parseFloat((document.getElementById('gen-penalty')||{value:2.5}).value) || 2.5;
                    const scores = students.map(s => {
                        const dist = daysDistanceNearest(s, dateStr, eventTypes, lookbackDays, lookforwardDays);
                        // base score is distance (larger better). apply a mild non-linear boost and randomness
                        const base = Math.log(dist + 1) * 1.0; // compress large distances
                        const rand = Math.random() * randomness; // user-tunable randomness
                        const penalty = (assignedCount[s] || 0) * penaltyCoeff; // penalize repeated picks in this run
                        const score = base + rand - penalty;
                        return { student: s, score };
                    });
                    scores.sort((a,b)=>b.score - a.score);
                    const chosen = [];
                    for (let i=0;i<scores.length && chosen.length < N;i++){
                        const s = scores[i].student;
                        if (!chosen.includes(s)){
                            chosen.push(s);
                            assignedCount[s] = (assignedCount[s] || 0) + 1;
                        }
                    }
                    // fallback if not enough chosen (shouldn't happen)
                    let idx = 0;
                    while (chosen.length < N){ if (idx >= students.length) break; const s = students[idx++]; if (!chosen.includes(s)){ chosen.push(s); assignedCount[s]++; } }

                    // create event
                    if (!eventsByCell[k]) eventsByCell[k] = [];
                    const text = defaultDescription('Interrogazione', subj);
                    eventsByCell[k].push({ type: 'Interrogazione', text: text, assignees: chosen, time: new Date().toLocaleTimeString() });
                }
                // cleanup selections
                generatorSelections.forEach(k=>{ const cell = document.getElementById(k); if (cell){ cell.classList.remove('assign-selected'); if (cell.dataset.prevTitle !== undefined) delete cell.dataset.prevTitle; } });
                generatorSelections.clear(); generatorMode = false; updateGenModal();
                updateEventsPanel(); renderWeek(currentWeekIndex);
                try { hideAllModals(); } catch (e) {}
            }

            // helper to update toolbar
            window.updateAssignToolbar = function(){
                const toolbar = document.getElementById('assign-toolbar');
                const count = document.getElementById('assign-count');
                count.innerText = `Selezionati: ${selectedAssignments.size}`;
                if (selectionMode){ toolbar.style.display = 'flex'; }
                else { toolbar.style.display = 'none'; }
            };

            updateCellSize();
            renderWeek(currentWeekIndex);
            window.addEventListener('resize', updateCellSize);
        });
    </script>
    <style>
        :root {
            --cell-size: 52px;
            --header-height: 40px;
            --gap: 6px;
            --label-width: 42px;
            --events-panel-width: 300px;
        }

        html { font-size: clamp(12px, 1.2vw, 16px); }
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f2f6fb;
            padding-right: var(--events-panel-width);
        }

        .griglia-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            right: var(--events-panel-width);
            height: 100vh;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 12px;
            box-sizing: border-box;
        }

        .content {
            width: max-content;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            box-sizing: border-box;
        }

        .labels {
            display: grid;
            grid-template-rows: var(--header-height) repeat(5, var(--cell-size));
            gap: var(--gap);
            align-items: center;
            justify-items: center;
        }

        .label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--label-width);
            height: var(--cell-size);
            box-sizing: border-box;
            background: #1e90ff;
            color: white;
            font-weight: 700;
            padding: 4px;
            border-radius: 6px;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .label.header-empty {
            height: var(--header-height);
            background: transparent;
            color: inherit;
            font-weight: 400;
            width: var(--label-width);
        }

        .griglia {
            width: max-content;
            display: grid;
            grid-template-columns: repeat(6, var(--cell-size));
            grid-template-rows: var(--header-height) repeat(5, var(--cell-size));
            gap: var(--gap);
            padding: 8px;
            box-sizing: border-box;
            background-color: transparent;
        }

        .griglia .header,
        .griglia .cell {
            cursor: pointer;
            outline: none;
            transition: transform 0.06s ease, box-shadow 0.08s ease;
        }

        .griglia .header {
            display: flex;
            align-items: center;
            justify-content: center;
            height: var(--header-height);
            background: linear-gradient(#2a9df4,#1e90ff);
            color: white;
            font-weight: 700;
            padding: 6px;
            box-sizing: border-box;
            white-space: nowrap;
            border-radius: 6px;
            min-width: var(--cell-size);
        }

        .griglia .cell {
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            width: var(--cell-size);
            height: var(--cell-size);
            box-sizing: border-box;
            padding: 0;
            border-radius: 6px;
            position: relative;
        }

        /* pill materie: ora riempie completamente la cella */
        .subject-pill {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            border-radius: 6px;
            font-size: 0.85rem;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal; /* allow wrapping so long subject names don't overflow */
            padding: 0 6px;
            box-sizing: border-box;
        }

        /* badge conteggio eventi */
        .ev-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 12px;
            line-height: 18px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 1px 0 rgba(0,0,0,0.12);
            pointer-events: none;
        }

        /* visual indicator for cells selected to receive a pending event */
        .cell.assign-selected { box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.45); transform: translateY(-2px); }

        .subject-mini-pill {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 4px;
            vertical-align: middle;
            margin-left: 6px;
        }

        /* bordi/indicatori evento (inset box-shadow per non rompere il layout) */
        .cell.ev-verifica .subject-pill {
            box-shadow: inset 0 0 0 3px rgba(220,20,60,0.95); /* rosso */
        }
        .cell.ev-interrogazione .subject-pill {
            box-shadow: inset 0 0 0 3px rgba(255,215,0,0.95); /* giallo */
            color: #000;
        }
        /* per ritardo/uscita: cella diventa visivamente opaca/grigia */
        .cell.ev-ritardo {
            opacity: 0.45;
            filter: grayscale(60%);
        }

        /* selezione normale */
        .griglia .header.selected {
            transform: translateY(-1px);
        }
        .griglia .cell.selected {
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }

        /* pannello eventi a destra */
        #events-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--events-panel-width);
            height: 100vh;
            box-sizing: border-box;
            padding: 16px;
            background: #ffffff;
            border-left: 1px solid #e6e9ef;
            overflow-y: auto;
        }
        #events-panel h2 { margin: 0 0 8px 0; font-size: 1.1rem; }
        .events-day { margin-bottom: 12px; border-bottom: 1px solid #f0f2f5; padding-bottom: 8px; }
        .events-day-title { font-weight: 700; margin-bottom: 6px; color: #333; }
        .events-list { margin: 0; padding-left: 12px; }
        .events-list li { margin-bottom: 8px; font-size: 0.95rem; color: #222; background:#fff; padding:6px;border-radius:6px;border:1px solid #f1f4f8; box-shadow: 0 2px 6px rgba(12,24,40,0.03); word-break:break-word; white-space:normal; }
        .events-list li.ev-selected { background: #eef6ff; padding: 6px; border-radius: 6px; }

        /* interrogazioni accordion */
        .interro-section { margin-bottom:12px; }
        .subj-accordion { display:flex; flex-direction:column; gap:6px; }
        .subj-accordion .subj-btn { display:flex; align-items:center; justify-content:space-between; padding:8px 10px; background:#f7fbff; border:1px solid #e6f0ff; border-radius:6px; cursor:pointer; font-weight:700; }
        .subj-accordion .subj-btn:hover { background:#eef8ff; }
        .subj-accordion .subj-content { display:none; padding:8px 10px; border-radius:6px; background:#fff; border:1px solid #f0f4fb; }
        .subj-accordion .subj-content.open { display:block; }
        .subj-rows { display:flex; flex-direction:column; gap:6px; font-size:0.95rem; }
        .subj-rows .day-line { padding:6px; background:#fbfdff; border-radius:6px; border:1px solid #f3f6fb; }
        .subj-rows .other-line { padding:6px; background:#fff; border-radius:6px; border:1px dashed #f1f4f8; }

        /* overlay e modal cell */
        #event-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.18);
            z-index: 2000;
        }
        .modal-window {
            display: none;
            position: fixed;
            z-index: 2200;
            width: 520px;
            max-width: calc(100% - 48px);
            max-height: 80vh;
            overflow: auto;
            background: #fff;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.22);
            font-size: 14px;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%);
        }
        .cm-header { font-weight:700; margin-bottom:8px; }
        .cm-list { max-height: 260px; overflow:auto; margin-bottom:8px; display:flex; flex-direction:column; gap:8px; }
        .cm-item { display:flex; gap:8px; align-items:center; }
        .cm-item select, .cm-item .cm-text { padding:6px; border:1px solid #d7dbe0; border-radius:4px; }
        .cm-item .cm-text { flex:1; }
    .cm-item { flex-wrap:wrap; }
    .cm-item div { word-break:break-word; white-space:normal; }
        .cm-add { display:flex; gap:8px; align-items:center; margin-top:8px; }
        .cm-add select, .cm-add input { padding:6px; border:1px solid #d7dbe0; border-radius:4px; }
        .cm-add input { flex:1; }
        .cm-add button, .cm-item button { padding:6px 8px; cursor:pointer; border-radius:4px; background:#f7f9fb; border:1px solid #cfd6de; }

    /* modern button styles */
    button { padding:8px 10px; border-radius:8px; border:1px solid #d0d7e0; background: linear-gradient(#ffffff,#f5f8fb); cursor:pointer; box-shadow: 0 4px 10px rgba(12,24,40,0.04); }
    button:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(12,24,40,0.06); }
    button:disabled { opacity:0.5; transform:none; cursor:not-allowed; box-shadow:none; }

        /* overlay/form fallback */
        @media (max-width: 760px) {
            .modal-window { left: 10px; right: 10px; top: 40px; transform: none; width: auto; max-height: calc(100vh - 80px); }
        }

        /* Responsive layout adjustments for small screens and tablets */
        @media (max-width: 1024px) {
            :root { --events-panel-width: 320px; }
            .griglia { gap: calc(var(--gap) * 0.8); }
            .label { font-size: 0.85rem; }
        }
        @media (max-width: 760px) {
            /* move events panel to bottom on small screens */
            body { padding-right: 0; padding-bottom: 45vh; }
            .griglia-wrapper { right: 0; top: 0; bottom: 45vh; height: calc(100vh - 45vh); overflow-y: auto; }
            #events-panel { position: fixed; right: 0; bottom: 0; top: auto; width: 100%; height: 45vh; border-left: none; border-top: 1px solid #e6e9ef; }
            .modal-window { left: 50%; transform: translateX(-50%); top: 6vh; max-height: 88vh; width: calc(100% - 24px); }
            .griglia { grid-template-columns: repeat(6, calc(var(--cell-size) * 0.9)); grid-template-rows: var(--header-height) repeat(5, calc(var(--cell-size) * 0.9)); }
            .subject-pill { font-size: 0.78rem; }
            #events-panel { padding: 10px; font-size: 0.95rem; }
            /* keep labels visible and close to grid */
            .content { gap: 6px; }
            /* make labels sticky and visible (white background) so hours don't disappear on mobile */
            .labels { position: sticky; left: 8px; z-index: 2600; background: rgba(255,255,255,0.95); padding-right:6px; }
            .labels .label { box-shadow: 0 6px 12px rgba(10,20,40,0.04); }
            /* allow header text to wrap on small screens so full day names are visible */
            .griglia .header { white-space: normal; line-height: 1.05; }
        }
        @media (max-width: 420px) {
            /* phone portrait: compact everything */
            html { font-size: clamp(11px, 2.5vw, 14px); }
            .griglia { gap: calc(var(--gap) * 0.6); }
            .subject-pill { font-size: 0.7rem; }
            .modal-window { padding: 8px; }
            #events-panel { height: 50vh; }
            /* stronger compacting and ensure minimal spacing between cells */
            :root { --gap: 4px; --label-width: 36px; }
            .content { gap: 4px; }
            .labels { position: sticky; left: 6px; z-index: 1600; background: rgba(255,255,255,0.0); padding-right:4px; }
            .labels .label { width: var(--label-width); }
            .griglia { grid-template-columns: repeat(6, calc(var(--cell-size) * 0.85)); grid-template-rows: var(--header-height) repeat(5, calc(var(--cell-size) * 0.85)); }
            .griglia-wrapper { padding-left: 6px; padding-right: 6px; }
        }
    </style>
</head>

<body>
    <div class="griglia-wrapper">
        <div class="content">
            <div class="griglia"></div>
        </div>
    </div>
</body>

</html>